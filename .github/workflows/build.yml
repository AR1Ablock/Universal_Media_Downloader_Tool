name: Build and Package MediaDownloader

on:
  push:
    tags:
      - 'v*'  # Trigger on tags like v1.0

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
      - uses: actions/setup-node@v4
        with: { node-version: '20' }  # Adjust for your Vue version
      - name: Publish Backend
        run: |
          cd 'Downloader_Backend_(Both_Stacks_Here)'
          dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true
      - name: Install WiX Toolset
        run: dotnet tool install --global wix --version 5.0.0
      - name: Build MSI with WiX
        run: |
          cd 'Downloader_Backend_(Both_Stacks_Here)'
          wix build Installer.wixproj -o MediaDownloader.msi
      - uses: actions/upload-artifact@v4
        with: { name: windows-msi, path: 'Downloader_Backend_(Both_Stacks_Here)/MediaDownloader.msi' }

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Publish Backend
        run: |
          cd Downloader_Backend_\(Both_Stacks_Here\)
          dotnet publish -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -o publish/linux-x64
      - name: Install fpm
        run: sudo apt update && sudo apt install ruby ruby-dev -y && sudo gem install fpm
      - name: Build DEB
        run: fpm --verbose -s dir -t deb -n mediadownloader -v 1.0 --prefix /opt/mediadownloader --description "Media Downloader App" --deb-desktop ../desktop.ini publish/linux-x64/=.
      - uses: actions/upload-artifact@v4
        with: { name: linux-deb, path: '*.deb' }

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Publish Backend
        run: |
          cd Downloader_Backend_\(Both_Stacks_Here\)
          dotnet publish -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true -o publish/osx-x64
      - name: Create App Bundle
        run: |
          mkdir -p MediaDownloader.app/Contents/MacOS
          cp Downloader_Backend_\(Both_Stacks_Here\)/publish/osx-x64/Downloader_Backend MediaDownloader.app/Contents/MacOS/
          cp Downloader_Backend_\(Both_Stacks_Here\)/Info.plist MediaDownloader.app/Contents/
          cp -r Downloader_Backend_\(Both_Stacks_Here\)/publish/osx-x64/tools MediaDownloader.app/Contents/Resources/  # Optional for tools
          cp -r Downloader_Backend_\(Both_Stacks_Here\)/publish/osx-x64/wwwroot MediaDownloader.app/Contents/Resources/
      - name: Install create-dmg
        run: brew install create-dmg
      - name: Build DMG with Retry
        run: |
          for i in {1..3}; do
            create-dmg --volname "MediaDownloader" --overwrite MediaDownloader.dmg MediaDownloader.app/ && break
            echo "Retry $i failed, waiting 10s..."
            sleep 10
          done
      - uses: actions/upload-artifact@v4
        with: { name: macos-dmg, path: '*.dmg' }
