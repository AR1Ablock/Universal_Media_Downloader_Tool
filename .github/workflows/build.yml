name: Build MediaDownloader

on:
  push:
    paths:
      - '.github/workflows/build.yml'

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            runtime: win-x64
            name: MediaDownloader-Windows-x64
            ext: zip
          - os: ubuntu-latest
            runtime: linux-x64
            name: MediaDownloader-Linux-x64
            ext: deb
          - os: macos-latest
            runtime: osx-x64
            name: MediaDownloader-macOS-x64
            ext: dmg

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish the app
        run: |
          dotnet publish "Downloader_Backend_(Both_Stacks_Here)/Downloader_Backend.csproj" \
            -c Release \
            -r ${{ matrix.runtime }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeAllContentForSelfExtract=true \
            -o publish
        shell: bash

      - name: Create installer / package
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            powershell -Command "Compress-Archive -Path publish/* -DestinationPath '${{ matrix.name }}.${{ matrix.ext }}' -Force"
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            sudo apt update && sudo apt install -y ruby ruby-dev
            sudo gem install fpm
            cd publish
            chmod +x Downloader_Backend
            mkdir -p usr/share/applications
            cp $GITHUB_WORKSPACE/desktop.ini usr/share/applications/mediadownloader.desktop
            fpm --verbose -s dir -t deb -n mediadownloader -v 1.0 \
              --prefix /opt/mediadownloader \
              --description "Universal Media Downloader" \
              .
            mv mediadownloader_1.0_amd64.deb $GITHUB_WORKSPACE/${{ matrix.name }}.${{ matrix.ext }}
          else
            mkdir -p MediaDownloader.app/Contents/{MacOS,Resources}
            cp publish/Downloader_Backend* MediaDownloader.app/Contents/MacOS/ 2>/dev/null || true
            cp Downloader_Backend_\(Both_Stacks_Here\)/Info.plist MediaDownloader.app/Contents/ 2>/dev/null || true
            cp -r publish/tools MediaDownloader.app/Contents/Resources/ 2>/dev/null || true
            cp -r publish/wwwroot MediaDownloader.app/Contents/Resources/ 2>/dev/null || true
            
            brew install create-dmg
            create-dmg --volname "Media Downloader" \
                       --app-drop-link 600 185 \
                       "${{ matrix.name }}.${{ matrix.ext }}" \
                       MediaDownloader.app/
          fi
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}.${{ matrix.ext }}
