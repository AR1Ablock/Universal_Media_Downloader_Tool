name: Build and Package MediaDownloader

on:
  push:
    tags:
      - 'v*'  # Trigger on tags like v1.0

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
      - name: Debug Directory
        run: |
          pwd
          ls -R
      - name: Publish Backend
        run: |
          cd 'Downloader_Backend_(Both_Stacks_Here)'
          dotnet publish Downloader_Backend.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o publish/win-x64
      - name: Install WiX Toolset
        run: dotnet tool install --global wix --version 5.0.0
      - name: Add WiX to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
        shell: bash
      - name: Build MSI with WiX
        run: |
          cd 'Downloader_Backend_(Both_Stacks_Here)'
          wix build -o MediaDownloader.msi Product.wxs
      - uses: actions/upload-artifact@v4
        with: { name: windows-msi, path: 'Downloader_Backend_(Both_Stacks_Here)/MediaDownloader.msi' }

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
      - name: Debug Directory
        run: |
          pwd
          ls -R
      - name: Publish Backend
        run: |
          cd Downloader_Backend_\(Both_Stacks_Here\)
          dotnet publish Downloader_Backend.csproj -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -o publish/linux-x64
      - name: Install fpm
        run: sudo apt update && sudo apt install ruby ruby-dev -y && sudo gem install fpm
      - name: Build DEB
        run: fpm --verbose -s dir -t deb -n mediadownloader -v 1.0 --prefix /opt/mediadownloader --description "Media Downloader App" --deb-desktop ../desktop.ini publish/linux-x64/=.
      - uses: actions/upload-artifact@v4
        with: { name: linux-deb, path: '*.deb' }

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
      - name: Debug Directory
        run: |
          pwd
          ls -R
      - name: Publish Backend
        run: |
          cd Downloader_Backend_\(Both_Stacks_Here\)
          dotnet publish Downloader_Backend.csproj -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true -o publish/osx-x64
      - name: Create App Bundle
        run: |
          mkdir -p MediaDownloader.app/Contents/MacOS
          mkdir -p MediaDownloader.app/Contents/Resources
          cp ./Downloader_Backend_\(Both_Stacks_Here\)/publish/osx-x64/Downloader_Backend MediaDownloader.app/Contents/MacOS/
          cp ./Downloader_Backend_\(Both_Stacks_Here\)/Info.plist MediaDownloader.app/Contents/
          cp -r ./Downloader_Backend_\(Both_Stacks_Here\)/publish/osx-x64/tools MediaDownloader.app/Contents/Resources/ || true  # Optional
          cp -r ./Downloader_Backend_\(Both_Stacks_Here\)/publish/osx-x64/wwwroot MediaDownloader.app/Contents/Resources/ || true
      - name: Install create-dmg
        run: brew install create-dmg
      - name: Build DMG with Retry
        run: |
          for i in {1..3}; do
            create-dmg --volname "MediaDownloader" --app-drop-link 600 185 --overwrite MediaDownloader.dmg MediaDownloader.app/ && break
            echo "Retry $i failed, waiting 10s..."
            sleep 10
          done
      - uses: actions/upload-artifact@v4
        with: { name: macos-dmg, path: '*.dmg' }
