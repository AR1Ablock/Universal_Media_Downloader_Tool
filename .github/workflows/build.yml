name: Build MediaDownloader

on:
  push:
    paths:
      - '.github/workflows/build.yml'

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            runtime: win-x64
            artifact: MediaDownloader-Windows-x64
            tools: "ffmpeg.exe|yt-dlp.exe"
          - os: ubuntu-latest
            runtime: linux-x64
            artifact: MediaDownloader-Linux-x64
            tools: "ffmpeg|yt-dlp"
          - os: macos-latest
            runtime: osx-x64
            artifact: MediaDownloader-macOS-x64
            tools: "ffmpeg_mac|yt-dlp_mac"

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Publish optimized single-file
        run: |
          dotnet publish "Downloader_Backend_(Both_Stacks_Here)/Downloader_Backend.csproj" \
            -c Release \
            -r ${{ matrix.runtime }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeAllContentForSelfExtract=true \
            -p:EnableCompressionInSingleFile=true \
            -o publish
        shell: bash

      - name: Copy tools + wwwroot + Keep only OS-specific tools + Fix permissions + Favicon
        run: |
          # Explicitly copy tools and wwwroot (this fixes macOS "no such directory")
          cp -r "Downloader_Backend_(Both_Stacks_Here)/tools" publish/ 2>/dev/null || true
          cp -r "Downloader_Backend_(Both_Stacks_Here)/wwwroot" publish/ 2>/dev/null || true

          cd publish/tools || true
          # Delete unwanted tools (keep only OS-specific)
          ls | grep -vE '${{ matrix.tools }}' | xargs rm -f 2>/dev/null || true
          # Make all remaining tools executable
          chmod +x * 2>/dev/null || true
          cd ..

          # Linux only: copy favicon to root for desktop shortcut
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            cp publish/wwwroot/favicon.png publish/ || true
          fi
        shell: bash

      - name: Create installer
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            powershell -Command "Compress-Archive -Path publish/* -DestinationPath '${{ matrix.artifact }}.zip' -Force"
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            sudo apt update && sudo apt install -y ruby ruby-dev
            sudo gem install fpm
            cd publish
            mkdir -p usr/share/applications
            cp $GITHUB_WORKSPACE/desktop.ini usr/share/applications/mediadownloader.desktop
            fpm --verbose -s dir -t deb -n mediadownloader -v 1.0 \
              --prefix /opt/mediadownloader \
              --description "Universal Media Downloader" \
              .
            mv mediadownloader_1.0_amd64.deb $GITHUB_WORKSPACE/${{ matrix.artifact }}.deb
          else
            mkdir -p MediaDownloader.app/Contents/{MacOS,Resources}
            cp publish/Downloader_Backend* MediaDownloader.app/Contents/MacOS/ 2>/dev/null || true
            cp Downloader_Backend_\(Both_Stacks_Here\)/Info.plist MediaDownloader.app/Contents/ 2>/dev/null || true
            cp -r publish/tools MediaDownloader.app/Contents/Resources/ 2>/dev/null || true
            cp -r publish/wwwroot MediaDownloader.app/Contents/Resources/ 2>/dev/null || true
            brew install create-dmg
            create-dmg --volname "Media Downloader" \
                       --app-drop-link 600 185 \
                       "${{ matrix.artifact }}.dmg" \
                       MediaDownloader.app/
          fi
        shell: bash

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.*
